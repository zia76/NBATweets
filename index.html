<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en">
	<head>
		<title>Mapping Tweets About the NBA Finals</title>
		<meta charset="utf-8">
		<link href="/d3-geomap-0.1.2/css/d3.geomap.css" rel="stylesheet">
		<link href='http://fonts.googleapis.com/css?family=Lato:300,400' rel='stylesheet' type='text/css'>
		<script src="d3-geomap-0.1.2/js/d3.js" charset="utf-8"></script>
		<script src="/d3-geomap-0.1.2/vendor/d3.geomap.dependencies.min.js"></script>
		<script src="d3-geomap-0.1.2/js/d3.geomap.nozoomnopan.js" charset="utf-8"></script>
		<style type="text/css">

			.title h2 {
			  font-family: 'Lato', sans-serif;
              color: #6D6D6D;
              text-align: center;
              margin-bottom: 0px;
            }

   			.subtitle h3 {
   			  font-family: 'Lato', sans-serif;
              color: #A0A0A0;
              text-align: center;
              margin-top: 0px;
              margin-bottom: 5px;
            }

            #chart-title {
              margin-top: 20px;
            }

            #chart-subtitle {
              margin-bottom: 0px;
            }

            #chart-note {
              margin-top: 30px;
              margin-bottom: 50px;
              margin-left: 20%;
              margin-right: 20%;
              display:block;

            }

            text {
              font-family: 'Lato', sans-serif;
              font-size: 16px;
              font-weight: 350;
              opacity: 0;
            }

            #map svg {
              margin-left: auto;
              margin-right: auto;
              display:block;
            }

            .chart svg {
            	margin-left: auto;
            	margin-right: auto;
            	display:block;
            	font-family: 'Lato', sans-serif;
              	color: #6D6D6D;
            }

            #option1 {
            	background: rgba(134, 0, 56, 0.8);
            	font-family: 'Lato', sans-serif;
            	font-size: 18px;
                font-weight: 400;
                margin-left: 35.5%;
            }

            #option2 {
            	background: rgba(0, 107, 182, 0.8);
            	font-family: 'Lato', sans-serif;
            	font-size: 18px;
                font-weight: 400;
            }

            .legend {
            	font-family: 'Lato', sans-serif;
            	color: #3E3E3E;
            	margin: 0 auto;
            }

            .legend circle {
  				fill: none;
  				stroke: #7A7A7A;
  				stroke-width: 2px;
			}

			.col-2 {
    		    width: 12%;
    		    margin-left: 2.5%;
    		    margin-right: 2.5%;
    		    font-family: 'Lato', sans-serif;
    		    height: 30px;
			}


			#timeLegend {
				margin-top: 5px;
				width: 770px;
				height: 20px;
			}

			#tickLegend {
				width: 770px;
				height: 25px;
			}

			#timeBall {
				margin: 0 auto;
				width: 770px;
				height: 40px;
			}


			#charts {
				height: 330px;
				margin-top: 40px;
				margin-bottom: 90px;

			}

			.axis path,
			.axis line {
				fill: none;
				stroke: black;
				shape-rendering: crispEdges;
			}

			.axis text {
				font-family: sans-serif;
				font-size: 11px;
				opacity: 1;
			}


		</style>

	</head>
	<body>
		<div id = "title" class="title"> <h2>Who tweeted about the NBA finals</h2></div>
		<div id = "subtitle" class="subtitle"> <h3>The day of the final game of the 2015 season</h3></div>
		<div id="map">
		</div>

		<script type="text/javascript">


		var format = function(d) {
    		return d3.format('.04r')(d);
			}

		var projection = d3.geo.mercator()
			.scale([150]);

		function getLongLat(x, a){
			if (x === null) {
				return -10;
			}
			else {
				return x[a];
			}
		}

		//uses datafile name to choose proper color to use for each data source
		function GetColor(f) {
			if (f.slice(5,13) == "Warriors") {
				return "#006BB6" //Warriors blue
			}
			else return "#860038" //Cavaliers burgundy
		}

		//generate a data array from passed in list of lists of text and x,y coords
		function generateDataset(dataset) {
			var data = [];
			if (typeof dataset[0] == "string") { //if so it's a single text/coord set
				data = [{"t": dataset[0], "x": dataset[1], "y": dataset[2]}];
			}
			else { //must loop through to process all text
			for (i=0; i<dataset.length; i++) {
				d = {"t": dataset[i][0], "x": dataset[i][1], "y": dataset[i][2]};
				data.push(d);
				}
			}
			return data;
		}


		//posts statistics text overlayed on the world map
		function postStats(dataset) {
			var data = generateDataset(dataset);
			//generate the data array from arguments
			if (typeof dataset[0] == "string") {
				data = [{"t": dataset[0], "x": dataset[1], "y": dataset[2]}];
			}
			else {
			for (i=0; i<dataset.length; i++) {
				d = {"t": dataset[i][0], "x": dataset[i][1], "y": dataset[i][2]};
				data.push(d);
				}
			}

			//find any old text currently posted and remove
			var stats = d3.select("body").select("#map").select("svg")
				.select("g")
			stats.attr("width", 750)
                .attr("height", 500);
			statsText = stats.selectAll("text")
			statsText.remove();
            
            //post new text from dataset
            var statsText = stats.selectAll("text")
                .data(data)
                .enter()
                .append("text")
            statsText.attr("x", function(d) {return d.x;})
                .attr("y", function(d) {return d.y;})
                .text(function(d) {return d.t;})
                .style("fill", "#7A7A7A");
            statsText.transition().delay(8000).duration(4000)
            	.style("opacity", 1);
		}


		//loads data and adds points to map
		function updateData(datafile) {
			d3.csv(datafile, function(dataset) {

				//remove all old circles on the page before redrawing
				var oldCircles = d3.selectAll('circle');
				oldCircles.style("fill", "none")
					.transition()
					.duration(750)
					.attr('r', 0)
					oldCircles.remove();

				//compute time intervals in dataset for animation
			    var maxTime = d3.max(dataset, function(d) { return d.time; });
			    var minTime = d3.min(dataset, function(d) { return d.time; });
			    var duration = maxTime - minTime;

			    //bind data to circles and plot on map
			    var bubbles = d3.select("#map").select("svg").selectAll("circle")
			    
			    //use lat as key function so that new dots don't bind to same indices as old dots
			    .data(dataset, function(d) { return d.lat; });
			    
			    //append and style new circles pre- and post-transition
				var newBubbles = bubbles.enter().append("circle");

				newBubbles.attr("cx", function(d) {
					var x = projection([d.long, d.lat]);
					return getLongLat(x, 0);
					})
					.attr("cy", function(d) {
					var x = projection([d.long, d.lat]);
					return getLongLat(x, 1);
					})
					.style("fill", GetColor(datafile))
					.style("opacity", 0.4)
					.attr("r", 0)
                	.transition().duration(2500)
                	.delay(function(d) { return 8000 * (d.time - minTime) / duration; })
                	.attr("r", 4);

                //add ripples that appear along with newBubbles above but dont' persist visually
                var ripples = bubbles.enter().append("circle");

				ripples.attr("cx", function(d) {
					var x = projection([d.long, d.lat]);
					return getLongLat(x, 0);
					})
					.attr("cy", function(d) {
					var x = projection([d.long, d.lat]);
					return getLongLat(x, 1);
					})
					.style("fill", GetColor(datafile))
					.style("opacity", 0.75)
					.style("stroke-width", 1)
					.style("stroke", "#6D6D6D")
					.attr("r", 0)
                	.transition().duration(1500)
                	.delay(function(d) { return 8000 * (d.time - minTime) / duration; })
                	.attr("r", 20)
                	.style("opacity", 0); //fades out to invisible, but objects still exist

                //re-draw map legend circles, which are erased each button press
                var balls = d3.select('#timeBall').select('svg');
                var endBalls = balls.selectAll('circle')
                	.data([15,755]);
                endBalls.enter().append('circle')
                .attr("cx", function(d) {
                	return d;
                })
                .attr("cy", 15)
                .attr("r", 14);

                //make the colored ball that moves across legend to indicate passage of time
                var colorBall = d3.select('#timeBall').select('svg')
                	.selectAll('circle')
                	.data([15,755,0]);
                colorBall.enter().append('circle')
                	.attr("cx", 15).attr("cy", 15).attr("r", 14)
                	.style("fill", GetColor(datafile))
                	.style("opacity", 1)
					.style("stroke-width", 0)
                	.transition().duration(8000).ease("linear")
                	.attr("cx", 755);

                
		    })
		}


		//draw background map
		var map = d3.geomap()
    		.geofile('/d3-geomap-0.1.2/topojson/world/countries.json')
    		.projection(d3.geo.mercator)
			.scale([150]);

		d3.select('#map')
    		.call(map.draw, map);

    	//add instructions text to map
    		//create text container
			var instructions = d3.select("body").select("#map").select("svg").select("g");
			instructions.attr("width", 750).attr("height", 500);
			
            //post text
            var instructionText = [['Each circle represents', 570, 430],
                     ['a single tweet', 600, 445],
                     ['Click on a box below to see', 555, 380],
                     ['tweets for each hashtag', 564, 395]];
            var data = generateDataset(instructionText);
            var text = instructions.selectAll("text")
                .data(data)
                .enter()
                .append("text")
            	.attr("x", function(d) {return d.x;})
                .attr("y", function(d) {return d.y;})
                .text(function(d) {return d.t;})
                .style("fill", "#7A7A7A")
            	.transition().delay(1000).duration(2000)
            	.style("opacity", 1);

		</script>


		<div id="timeLegend" class="legend">
			<t style="margin-left:0px;">Noon</t>
			<t style="margin-left:436px;">Tipoff</t>
			<t style="margin-left:38px;">Halftime</t>
			<t style="margin-left:78px;">End</t>
		</div>
		<div id="tickLegend" class="legend">
			<t style="margin-left:13px;">|</t>
			<t style="margin-left:475px;">|</t>
			<t style="margin-left:72px;">|</t>
			<t style="margin-left:22px;">|</t>
			<t style="margin-left:101px;">|</t>
		</div>
		
		<div id="timeBall" class="legend">
			<svg width="840px" height="40px">
				<circle cx="15" cy="15" r="14"></circle>
				<circle cx="755" cy="15" r="14"></circle>
			</svg>
		</div>

        <div id = "option">
        	 
             <input id = "option1"
                 class = "col-2"
                 name="CavaliersButton"
                 type="button"
                 value="#Cavaliers"
                 onclick="updateData('data/CavaliersCoords.csv');
                     postStats([['Impressive, but still 4.9x', 48, 370],
                     ['fewer than #Warriors', 54, 385],
                     ['#Cavaliers was tweeted 94,673 times', 2, 320],
                     ['over 9.5 hours around game time', 21, 335],
                     ['Only 1 in 466 Cavaliers tweets', 620, 440],
                     ['had GPS information', 658, 455]]);" />
             <input id = "option2"
        	     class = "col-2 Warrior"
        	     name="WarriorsButton" 
                 type="button" 
                 value="#Warriors"
                 style="background-color: #006BB6"
                 onclick="updateData('data/WarriorsCoords.csv');
                     postStats([['That\'s 4.9x more', 66, 370],
                     ['than #Cavaliers', 71, 385],
                     ['#Warriors was tweeted 531,415 times', 0, 320],
                     ['over 9.5 hours on game day', 36, 335],
                     ['Only 1 in 310 Warriors tweets', 620, 440],
                     ['had GPS information', 658, 455]]);" />
        </div>

        <div id = "charts">
			<div2 id = "chart-title" class="title"> <h2>Tweets Per Minute</h2></div2>
			<div2 id = "chart-subtitle" class= "subtitle"> <h3>on Game Day</h3></div2>
        	<div2 id = "chart" class="chart"></div2>
        </div>
        <div id = "chart-note" class = "subtitle">
        	<h3>Tipoff was at 6:12pm Pacific.</h3>
        	<h3>When the Warriors won 105-97 at 8:58pm, tweets containing "#Warriors" exceeded 1% of total global tweet traffic, and could not even be counted using the Twitter API.</h3>
        </div>

		<script type="text/javascript">

		function drawHistogram(datafile1, datafile2, container) {

			var numBins = 60; //for splitting up dataset into histogram bins

			//hard-coding yMax for consistent scale w both charts
			//I got it programmatically inside d3.csv:
			//var yMax = d3.max(histogram, function(d) { return d.y;});
			//console.log(yMax);
			var yMax = 28500;

			var width = 740;
			var height = 300;
			var barpadding = 1;
			var padding = 40;
			var topPadding = 5;

			//create histogram, first binding Warriors data
			d3.csv(datafile1, function(data) {

				var maxTime = d3.max(data, function(d) { return d.time; });
				var minTime = d3.min(data, function(d) { return d.time; });
				var duration = maxTime - minTime;

				
				//console.log("minTime:", minTime, "maxTime:", maxTime);
				//console.log("total seconds:", duration, "total minutes:", duration/60);
				//console.log("minutes per bin:", duration/60/numBins);
				

				//convert units from unix timestamp to minutes since game start
				var map = data.map(function(d) { return parseInt(d.time); })

				var histogram = d3.layout.histogram()
					.bins(numBins)
					(map)

				var canvas = d3.select(container).append('svg')
					.attr('width', width + 2 * padding)
					.attr('height', height + padding + topPadding);

				var bars = canvas.selectAll('.bar')
					.data(histogram)
					.enter()
					.append('g')

				//console.log(d3.max(histogram, function(d) { return d.y;}));
				//console.log(histogram);

				bars.append('rect')
					.attr('x', function(d) {return ((d.x - minTime) / duration * width) + padding;})
					.attr('y', function(d) {return (height + topPadding) - height * (d.y / yMax);})
					.attr('width', function(d) {return (d.dx / duration * width) - barpadding;})
					.attr('height', function(d) { return height * (d.y / yMax);})
					.attr('fill', "#006BB6")
					.attr('opacity', 1);

				//Create scale functions
				var xScale = d3.time.scale()
					.domain([minTime*1000, maxTime*1000])
					.range([padding, width + padding]);

				var yScale = d3.scale.linear()
					//convert absolute tweets to tweets per minute in domain
					.domain([0, yMax / duration * 60 * numBins])
					.range([height + topPadding, topPadding]);

				//Define X axis
				var xAxis = d3.svg.axis()
					.scale(xScale)
					.orient("bottom")
					.ticks(9);

				//Define Y axis
				var yAxis = d3.svg.axis()
					.scale(yScale)
					.orient("left")
					.ticks(5);

				//Create X axis
				canvas.append("g")
					.attr("class", "axis")
					.attr("transform", "translate(0," + (height + topPadding) + ")")
					.call(xAxis);
			
				//Create Y axis
				canvas.append("g")
					.attr("class", "axis")
					.attr("transform", "translate(" + padding + ",0)")
					.call(yAxis);

				canvas.append("text") //label for x axis
        			.attr("x", width / 2 + padding )
        			.attr("y", height + topPadding + padding -5)
        			.style("text-anchor", "middle")
        			.style("class", "subtitle")
        			.style("opacity", 1)
        			.text("Pacific Time");

			})
			//add Cavaliers data to existing histogram
			d3.csv(datafile2, function(data2) {

				var maxTime = d3.max(data2, function(d) { return d.time; });
				var minTime = d3.min(data2, function(d) { return d.time; });
				var duration = maxTime - minTime;

				//convert units from unix timestamp to minutes since game start
				var map = data2.map(function(d) { return parseInt(d.time); })

				var histogram = d3.layout.histogram()
					.bins(numBins)
					(map);

				//we want the same svg appended above, so select svg, don't append new one
				var canvas = d3.select(container).select('svg');

				var bars = canvas.selectAll('.bar')
					.data(histogram)
					.enter()
					.append('g');
			
				bars.append('rect')
					.attr('x', function(d) {return ((d.x - minTime) / duration * width) + padding;})
					.attr('y', function(d) {return (height + topPadding) - height * (d.y / yMax);})
					.attr('width', function(d) {return (d.dx / duration * width) - barpadding;})
					.attr('height', function(d) { return height * (d.y / yMax);})
					.attr('fill', "#860038")
					.attr('opacity', 1);

			})

/*broken
			//add text note about maxout of warriors tweets in chart
			var note = canvas.selectAll("text");
			
            //text to post with locations
            var noteText = [['--As the Warriors won,', 0, 20],
                     ['#Warriors tweets exceeded 1%', 100, 30],
                     ['of global tweet traffic', 200, 40],
                     ['and could not be fully counted', 300, 50],
                     ['using the twitter streaming API', 400, 60]];
            

            var noteData = generateDataset(noteText);
            var text = note
                .data(noteData)
                .enter()
                .append("text")
				.attr("x", function(d) {return d.x;})
                .attr("y", function(d) {return d.y;})
                .text(function(d) {return d.t;})
                .attr("class", "subtitle")
                .style("fill", "#7A7A7A")
            	.style("opacity", 1);
end broken*/ 
			

		}

		    drawHistogram('data/WarriorsTweetTimes.csv', 'data/CavaliersTweetTimes.csv','#chart');


		</script>

	</body>
</html>
